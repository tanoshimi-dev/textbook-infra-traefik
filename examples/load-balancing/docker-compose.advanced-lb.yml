version: '3.8'

# Advanced Load Balancing with Circuit Breaker and Rate Limiting
# This shows production-ready load balancing configuration

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.advanced.yml:/etc/traefik/traefik.yml:ro
    networks:
      - traefik-network
    restart: unless-stopped

  # Flask app with rate limiting and circuit breaker
  flask-app:
    build: ../../app1-flask
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flask.rule=Host(`flask.localhost`)"
      - "traefik.http.routers.flask.entrypoints=web"

      # Apply middlewares
      - "traefik.http.routers.flask.middlewares=flask-ratelimit,flask-circuitbreaker"

      # Load balancer
      - "traefik.http.services.flask.loadbalancer.server.port=5000"

      # Health check
      - "traefik.http.services.flask.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.flask.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.flask.loadbalancer.healthcheck.timeout=3s"

      # Rate limiting middleware
      - "traefik.http.middlewares.flask-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.flask-ratelimit.ratelimit.burst=50"
      - "traefik.http.middlewares.flask-ratelimit.ratelimit.period=1s"

      # Circuit breaker middleware
      - "traefik.http.middlewares.flask-circuitbreaker.circuitbreaker.expression=NetworkErrorRatio() > 0.3 || ResponseCodeRatio(500, 600, 0, 600) > 0.3"

    networks:
      - traefik-network
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Node.js with retry and timeout
  nodejs-app:
    build: ../../app2-nodejs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nodejs.rule=Host(`nodejs.localhost`)"
      - "traefik.http.routers.nodejs.entrypoints=web"

      # Apply retry middleware
      - "traefik.http.routers.nodejs.middlewares=nodejs-retry"

      # Load balancer with passHostHeader
      - "traefik.http.services.nodejs.loadbalancer.server.port=3000"
      - "traefik.http.services.nodejs.loadbalancer.passHostHeader=true"

      # Retry middleware
      - "traefik.http.middlewares.nodejs-retry.retry.attempts=4"
      - "traefik.http.middlewares.nodejs-retry.retry.initialInterval=100ms"

      # Health check
      - "traefik.http.services.nodejs.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.nodejs.loadbalancer.healthcheck.interval=10s"

    networks:
      - traefik-network
    deploy:
      replicas: 2
    restart: unless-stopped

  # Static with compression
  static-app:
    build: ../../app3-static
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.static.rule=Host(`static.localhost`)"
      - "traefik.http.routers.static.entrypoints=web"

      # Apply compression
      - "traefik.http.routers.static.middlewares=static-compress"

      # Load balancer
      - "traefik.http.services.static.loadbalancer.server.port=80"

      # Compression middleware
      - "traefik.http.middlewares.static-compress.compress=true"

    networks:
      - traefik-network
    deploy:
      replicas: 2
    restart: unless-stopped

networks:
  traefik-network:
    driver: bridge
